from flask import Flask, render_template, request, jsonify
import threading
import subprocess
import time

app = Flask(__name__)

# Default download directory
download_directory = "/tmp/downloads"

# Function to run app.py and capture logs
def run_app():
    process = subprocess.Popen(['python', 'app.py', download_directory], stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    while True:
        output = process.stdout.readline()
        if output == b'' and process.poll() is not None:
            break
        if output:
            app.logger.info(output.decode().strip())

@app.route('/')
def index():
    return render_template('webui/index.html')

@app.route('/set_download_directory', methods=['POST'])
def set_download_directory():
    global download_directory
    data = request.get_json()
    new_directory = data.get('directory')
    if new_directory:
        download_directory = new_directory
        return jsonify({"message": f"Download directory set to {download_directory}"}), 200
    else:
        return jsonify({"error": "No directory provided"}), 400

if __name__ == '__main__':
    log_thread = threading.Thread(target=run_app)
    log_thread.start()
    app.run(debug=True, threaded=True)
